# github-action-push-static

This is an example GitHub Action workflow that will automatically push all files in a specified directory to a **different GitHub repo** using a [GitHub deploy key](https://docs.github.com/en/free-pro-team@latest/developers/overview/managing-deploy-keys). By enabling GitHub Pages for the destination repo, you can **serve content dynamically generated by a GitHub action workflow/job.**

## Use cases

- Publish static (gatsby, jekyll etc.) site to separate GitHub repository
- Publish build results to a web endpoint
- Publish istanbul test coverage from unit/integration tests
- Publish a custom badge like [shields.io](https://shields.io) (e.g a test coverage badge)

## Why?

- Free serving of public websites with git history (public repositories don't cost anything)
- Don't have to pay for services like `codecov.io` or `coveralls.io`
- Don't bloat your main repo with a long history of ever changing files.
- Don't risk exposing any personal github token from a github action (a leak which which could give someone access to your whole GitHub account).

## Generate SSH key-pair

Create an SSH key-pair and save it to the current directory on your computer (you can delete these files later):
```
ssh-keygen -t ed25519 -C "your_email@example.com" -f ./id_rsa -N ''
cat id_rsa.pub
cat id_rsa
```

## Create a public repository

[Create new public github repo](https://github.com/new) named `static-files-destination-repo`, and make sure it has at least one file so the branch `main` is created. This will be your destination repo where the Action will automatiicaly push the static files to.
- Go to `Settings` for the repository, then `Deploy keys`.
- Create a deploy key with **write access** and paste in the public key you just generated (`id_rsa.pub` contents).
- Also under repository `Settings` Enable GitHub Pages from the `main` branch

## Create the workflow

In our main (source) repository we will add GitHub Action workflow steps. These steps will checkout the `static-files-destination-repo` into a separate directory, and then copy and replace all files in that destination repo with files from the specified `static-build` directory.

1. Now, inside the **source repository** (the repo that will **push** the static content to the newly created `static-files-destination-repo` repo), create a `.github/workflows/workflow.yml` (or modify your existing workflow file by adding the below steps). 
2. Make sure your own steps prior to these steps will generate the files under `static-build`. Files inside this folder will be published to the root of the GitHub Pages site, or replace `static-build` below with the path to your generated static files.
3. Replace `repository: your-username/static-files-destination-repo` with your github username slash your newly created repo name.

`.github/workflows/workflow.yml`

```yml
name: My workflow

on: [push]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      #
      # Insert any of your own steps to generate the static content here (in a directory called `static-build`)
      # e.g. npm run build or npm run test covarage
      #

      # *** BEGIN PUBLISH STATIC SITE STEPS ***
      # Use the standard checkout action to check out the destination repo to a separate directory
      # See https://github.com/mifi/github-action-push-static
      - uses: actions/checkout@v2
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          repository: repository: your-username/static-files-destination-repo # *** REPLACE WITH YOUR OWN ***
          path: static-files-destination

      # Now we will copy/replace all files in the cloned destination folder, and finally push the changes:
      - run: |
          git config --global user.name github-actions
          git config --global user.email github-actions@github.com
          # Remove existing files:
          rm -rf static-files-destination/*
          # Replace with new files:
          cp -a static-build/* static-files-destination/
          cd static-files-destination
          git add .
          # git diff-index: to avoid doing the git commit failing if there are no changes to be commit
          git diff-index --quiet HEAD || git commit --message 'Static file updates'
          git push
```

In the same (source) repository go to the GitHub `Settings` > `Secrets` menu and create a new repository secret. In this example, we'll call it `SSH_PRIVATE_KEY`. Put the contents of the private SSH key you generated before (`id_rsa` file) into the contents field. This key should start with `-----BEGIN ... PRIVATE KEY-----`, consist of many lines and ends with `-----END ... PRIVATE KEY-----`.

## Finish up

Now commit and push your files in the source repository and check that the GitHub Action finishes. If all went well you should now find your files hosted under this path:

```
https://your-username.github.io/static-files-destination-repo/
```

## Custom GitHub badge ![](custom-badge/example.svg)

See [custom-badge/](custom-badge/)

## Inspiration

- https://github.com/cpina/github-action-push-to-another-repository
